<!DOCTYPE html>
<!-- Generated by claude-code-log v{{ library_version }} -->
<html lang='en'>

<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>{{ title }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    {% from 'components/session_nav.html' import render_session_nav %}
    <style>
{% include 'components/global_styles.css' %}
{% include 'components/message_styles.css' %}
{% include 'components/session_nav_styles.css' %}
{% include 'components/filter_styles.css' %}
{% include 'components/todo_styles.css' %}
{% include 'components/timeline_styles.css' %}
{% include 'components/search_styles.css' %}
{% include 'components/edit_diff_styles.css' %}
{% include 'components/pygments_styles.css' %}
{% include 'components/page_nav_styles.css' %}
    </style>
</head>

<body>
    {% if combined_transcript_link %}
    <div class="navigation">
        <a href="{{ combined_transcript_link }}" class="combined-transcript-link">
            â† {% if combined_transcript_link == "index.html" %}View All Sessions{% else %}View All Sessions (Combined Transcript){% endif %}
        </a>
    </div>
    {% elif sessions and sessions|length > 1 %}
    <div class="navigation">
        <a href="../index.html" class="combined-transcript-link">&larr; All Projects</a>
    </div>
    {% endif %}

    <h1 id="title">{{ title }}</h1>

    {% if page_info %}
    <!-- Page Navigation -->
    <div class="page-navigation">
        <div class="page-header">
            <div class="page-title">Page {{ page_info.page_number }}</div>
            {% if page_stats %}
            <div class="page-stats">
                <span class="stat">ğŸ’¬ {{ page_stats.message_count }} messages</span>
                <span class="stat">ğŸ•’ {{ page_stats.date_range }}</span>
                {% if show_stats and page_stats.token_summary %}
                <span class="stat">ğŸª™ {{ page_stats.token_summary }}</span>
                {% endif %}
            </div>
            {% endif %}
        </div>
        <div class="page-nav-links">
            {% if page_info.prev_link %}
            <a href="{{ page_info.prev_link }}" class="page-nav-link prev">â† Previous</a>
            {% endif %}
            <!-- PAGINATION_NEXT_LINK_START -->
            <a href="{{ page_info.next_link }}" class="page-nav-link next{% if page_info.is_last_page %} last-page{% endif %}">Next â†’</a>
            <!-- PAGINATION_NEXT_LINK_END -->
        </div>
    </div>
    {% endif %}

    <!-- Timeline Component -->
    {% include 'components/timeline.html' %}

    <!-- Combined Search & Filter Toolbar -->
    <div class="filter-toolbar">
        <div class="toolbar-header">
            <h3>ğŸ” Search & Filter</h3>
            <button class="close-toolbar-btn" id="closeToolbar" title="Close">âœ•</button>
        </div>

        <!-- Inline Search -->
        {% include 'components/search_inline.html' %}

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-toggles">
                <button class="filter-toggle active" data-type="user">ğŸ¤· User <span class="count">(0)</span></button>
                <button class="filter-toggle active" data-type="system">âš™ï¸ System <span class="count">(0)</span></button>
                <button class="filter-toggle active" data-type="assistant">ğŸ¤– Assistant <span
                        class="count">(0)</span></button>
                <button class="filter-toggle active" data-type="thinking">ğŸ’­ Thinking <span
                        class="count">(0)</span></button>
                <button class="filter-toggle active" data-type="tool">ğŸ› ï¸ Tool <span
                        class="count">(0)</span></button>
                <button class="filter-toggle active" data-type="sidechain">ğŸ”— Sub-assistant <span
                        class="count">(0)</span></button>
                <button class="filter-toggle active" data-type="image">ğŸ–¼ï¸ Images <span class="count">(0)</span></button>
            </div>
            <div class="filter-actions">
                <button class="filter-action-btn" id="selectAll">All</button>
                <button class="filter-action-btn" id="selectNone">None</button>
            </div>
        </div>
    </div>


    {% if sessions and sessions|length > 1 %}
    {{ render_session_nav(sessions, "toc", show_stats=show_stats) }}
    {% endif %}

    {% for message, message_title, html_content, formatted_timestamp in messages %}
    {% if is_session_header(message) %}
    <div class="session-divider"></div>
    <div class='message session-header' data-message-id='{{ message.message_id }}' data-session-id='{{ message.session_id }}' id='msg-{{ message.message_id }}'>
        <div class='header'>Session: {{ html_content }}</div>
        {% if message.has_children %}
        <div class='fold-bar' data-message-id='{{ message.message_id }}' data-border-color='session-header'>
            <div class='fold-bar-section' data-action='fold-one' data-target='{{ message.message_id }}' data-title-unfolded='Fold {{ message.get_immediate_children_label() }}' data-title-folded='Unfold {{ message.get_immediate_children_label() }}' title='Fold {{ message.get_immediate_children_label() }}'>
                <span class='fold-icon'>â–¼</span>
                <span class='fold-label'>{{ message.get_immediate_children_label() }}</span>
            </div>
        </div>
        {% endif %}
    </div>
    {% else %}
    {%- set msg_css_class = css_class_from_message(message) %}
    {% set markdown = message.content.has_markdown if message.content else false %}
    <div class='message {{ msg_css_class }}{% if message.is_paired %} {{ message.pair_role }}{% endif %}{% if message.is_continuation %} continuation{% endif %}{% for ancestor_index in message.ancestry %} d-{{ ancestor_index }}{% endfor %}' data-message-id='{{ message.message_id }}' id='msg-{{ message.message_id }}'>
        {% if message.is_continuation %}
        <div class='content{% if markdown %} markdown{% endif %}'>
            <div class='continuation-meta'>
                <span class='timestamp'{% if message.meta and message.meta.timestamp %} data-timestamp='{{ message.meta.timestamp }}'{% endif %}>{{ formatted_timestamp }}</span>
                {% if show_stats and message.token_usage %}<span class='token-usage'>{{ message.token_usage }}</span>{% endif %}
            </div>
            {{ html_content | safe }}
        </div>
        {% else %}
        <div class='header'>
            {% set msg_emoji = get_message_emoji(message) -%}
            <span{% if message.title_hint %} title="{{ message.title_hint }}"{% endif %}>{% if message_title %}{%
                if message_title == 'Memory' %}ğŸ’­ {%
                elif msg_emoji and (message.type != 'tool_use' or not starts_with_emoji(message_title)) %}{{ msg_emoji }} {% endif %}{{ message_title | safe }}{% endif %}</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp'{% if message.meta and message.meta.timestamp %} data-timestamp='{{ message.meta.timestamp }}'{% if message.pair_duration %} data-duration='{{ message.pair_duration }}'{% endif %}{% endif %}>{{ formatted_timestamp }}</span>
                </div>
                {% if show_stats and message.token_usage %}
                <span class='token-usage'>{{ message.token_usage }}</span>
                {% endif %}
            </div>
        </div>
        <div class='content{% if markdown %} markdown{% endif %}'>{{ html_content | safe }}</div>
        {% endif %}
        {% if message.has_children %}
        <div class='fold-bar' data-message-id='{{ message.message_id }}' data-border-color='{{ msg_css_class }}'>
            <div class='fold-bar-section' data-action='fold-one' data-target='{{ message.message_id }}' data-title-unfolded='Fold {{ message.get_immediate_children_label() }}' data-title-folded='Unfold {{ message.get_immediate_children_label() }}' title='Fold {{ message.get_immediate_children_label() }}'>
                <span class='fold-icon'>â–¼</span>
                <span class='fold-label'>{{ message.get_immediate_children_label() }}</span>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
    {% endfor %}

    <button class="timeline-toggle floating-btn" id="toggleTimeline" title="Show timeline">ğŸ“†</button>
    <button class="filter-messages floating-btn" id="filterMessages" title="Search & Filter">ğŸ”</button>
    <button class="toggle-details floating-btn" id="toggleDetails" title="Toggle all details">ğŸ“‹</button>
    <a class="scroll-top floating-btn" title="Scroll to top" href="#title">ğŸ”</a>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const toggleButton = document.getElementById('toggleDetails');
            const timelineButton = document.getElementById('toggleTimeline');
            const filterButton = document.getElementById('filterMessages');
            const filterToolbar = document.querySelector('.filter-toolbar');
            const selectAllButton = document.getElementById('selectAll');
            const selectNoneButton = document.getElementById('selectNone');
            const closeToolbarButton = document.getElementById('closeToolbar');
            const filterToggles = document.querySelectorAll('.filter-toggle');

            // Timezone conversion (included as component)
            {% include 'components/timezone_converter.js' %}

            // Parse URL parameters
            function getUrlParams() {
                const params = new URLSearchParams(window.location.search);
                return {
                    filter: params.get('filter')  // e.g., "user,assistant"
                };
            }

            // Apply filters from URL parameters
            function applyUrlFilters() {
                const urlParams = getUrlParams();

                // Apply message type filter
                if (urlParams.filter) {
                    const types = urlParams.filter.split(',').map(t => t.trim().toLowerCase());

                    // Deactivate all toggles first
                    filterToggles.forEach(toggle => {
                        toggle.classList.remove('active');
                    });

                    // Activate only the specified types
                    types.forEach(type => {
                        const toggle = document.querySelector(`[data-type="${type}"]`);
                        if (toggle) {
                            toggle.classList.add('active');
                        }
                    });

                    // Show filter toolbar if filters are applied
                    filterToolbar.classList.add('visible');
                    filterButton.classList.add('active');
                }
            }

            // Timeline toggle functionality
            if (timelineButton) {
                timelineButton.addEventListener('click', function () {
                    if (window.toggleTimeline) {
                        window.toggleTimeline();
                    }
                });
            }

            // Toggle details functionality
            // Selector for all collapsible details elements (multiple classes)
            const collapsibleSelector = 'details.collapsible-details, details.collapsible-code, details.tool-param-collapsible';
            const collapsibleOpenSelector = 'details[open].collapsible-details, details[open].collapsible-code, details[open].tool-param-collapsible';

            function updateToggleButton() {
                const allDetails = document.querySelectorAll(collapsibleSelector);
                const openCount = document.querySelectorAll(collapsibleOpenSelector).length;
                const totalCount = allDetails.length;

                if (totalCount === 0) {
                    toggleButton.style.display = 'none';
                    return;
                }

                // If more than half are open, show "close all" state, otherwise show "open all"
                const mostlyOpen = openCount > totalCount / 2;
                toggleButton.textContent = mostlyOpen ? 'ğŸ“¦' : 'ğŸ—ƒï¸';
                toggleButton.title = mostlyOpen ? 'Close all details' : 'Open all details';
            }

            function toggleAllDetails() {
                const allDetails = document.querySelectorAll(collapsibleSelector);
                const openCount = document.querySelectorAll(collapsibleOpenSelector).length;
                const shouldOpen = openCount <= allDetails.length / 2;

                allDetails.forEach(details => {
                    if (shouldOpen) {
                        details.setAttribute('open', '');
                    } else {
                        details.removeAttribute('open');
                    }
                });

                updateToggleButton();
            }

            toggleButton.addEventListener('click', toggleAllDetails);

            // Filter toolbar toggle functionality
            function toggleFilterToolbar() {
                const isVisible = filterToolbar.classList.contains('visible');
                if (isVisible) {
                    filterToolbar.classList.remove('visible');
                    filterButton.classList.remove('active');
                    filterButton.title = 'Search & Filter';
                } else {
                    filterToolbar.classList.add('visible');
                    filterButton.classList.add('active');
                    filterButton.title = 'Close';
                    // Focus search input when opening
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        setTimeout(() => searchInput.focus(), 100);
                    }
                }
            }

            filterButton.addEventListener('click', toggleFilterToolbar);
            if (closeToolbarButton) {
                closeToolbarButton.addEventListener('click', toggleFilterToolbar);
            }

            // Count messages by type and update button labels
            function updateMessageCounts() {
                const messageTypes = ['assistant', 'sidechain', 'system', 'thinking', 'image'];

                messageTypes.forEach(type => {
                    const messages = document.querySelectorAll(`.message.${type}:not(.session-header)`);
                    const count = messages.length;
                    const toggle = document.querySelector(`[data-type="${type}"]`);
                    const countSpan = toggle ? toggle.querySelector('.count') : null;

                    if (countSpan) {
                        countSpan.textContent = `(${count})`;

                        // Hide toggles for message types with 0 count
                        if (count === 0) {
                            toggle.style.display = 'none';
                        } else {
                            toggle.style.display = 'flex';
                        }
                    }
                });

                // Handle combined "user" filter (user + bash-input + bash-output)
                const userMessages = document.querySelectorAll(`.message.user:not(.session-header), .message.bash-input:not(.session-header), .message.bash-output:not(.session-header)`);
                const userCount = userMessages.length;
                const userToggle = document.querySelector(`[data-type="user"]`);
                const userCountSpan = userToggle ? userToggle.querySelector('.count') : null;

                if (userCountSpan) {
                    userCountSpan.textContent = `(${userCount})`;
                    if (userCount === 0) {
                        userToggle.style.display = 'none';
                    } else {
                        userToggle.style.display = 'flex';
                    }
                }

                // Handle combined "tool" filter (tool_use + tool_result)
                const toolMessages = document.querySelectorAll(`.message.tool_use:not(.session-header), .message.tool_result:not(.session-header)`);
                const toolCount = toolMessages.length;
                const toolToggle = document.querySelector(`[data-type="tool"]`);
                const toolCountSpan = toolToggle ? toolToggle.querySelector('.count') : null;

                if (toolCountSpan) {
                    toolCountSpan.textContent = `(${toolCount})`;
                    if (toolCount === 0) {
                        toolToggle.style.display = 'none';
                    } else {
                        toolToggle.style.display = 'flex';
                    }
                }
            }

            // Filter functionality
            function applyFilter() {
                const activeTypes = Array.from(filterToggles)
                    .filter(toggle => toggle.classList.contains('active'))
                    .map(toggle => toggle.dataset.type);

                // Expand filter types to their corresponding CSS classes
                const expandedTypes = [];
                activeTypes.forEach(type => {
                    if (type === 'tool') {
                        expandedTypes.push('tool_use', 'tool_result');
                    } else if (type === 'user') {
                        // User filter includes bash commands (user-initiated)
                        expandedTypes.push('user', 'bash-input', 'bash-output');
                    } else {
                        expandedTypes.push(type);
                    }
                });

                // Show/hide messages based on active toggle buttons
                const allMessages = document.querySelectorAll('.message:not(.session-header)');
                allMessages.forEach(message => {
                    let shouldShow = false;

                    // Special handling for sidechain messages
                    if (message.classList.contains('sidechain')) {
                        // For sidechain messages, show if both sidechain filter is active AND their message type filter is active
                        const sidechainActive = expandedTypes.includes('sidechain');
                        const messageTypeActive = expandedTypes.some(type =>
                            type !== 'sidechain' && message.classList.contains(type)
                        );
                        shouldShow = sidechainActive && messageTypeActive;
                    } else {
                        // For non-sidechain messages, show if any of their types are active
                        shouldShow = expandedTypes.some(type => message.classList.contains(type));
                    }

                    if (shouldShow) {
                        message.classList.remove('filtered-hidden');
                    } else {
                        message.classList.add('filtered-hidden');
                    }
                });

                // Update visible counts in real-time
                updateVisibleCounts();

                // Update filter button appearance based on whether all types are selected
                const allTypesSelected = activeTypes.length === filterToggles.length;
                if (!allTypesSelected && filterToolbar.classList.contains('visible')) {
                    filterButton.classList.add('active');
                } else if (allTypesSelected && filterToolbar.classList.contains('visible')) {
                    filterButton.classList.add('active');
                }
            }

            function updateVisibleCounts() {
                const messageTypes = ['assistant', 'sidechain', 'system', 'thinking', 'image'];

                messageTypes.forEach(type => {
                    const visibleMessages = document.querySelectorAll(`.message.${type}:not(.session-header):not(.filtered-hidden)`);
                    const totalMessages = document.querySelectorAll(`.message.${type}:not(.session-header)`);
                    const visibleCount = visibleMessages.length;
                    const totalCount = totalMessages.length;

                    const toggle = document.querySelector(`[data-type="${type}"]`);
                    const countSpan = toggle ? toggle.querySelector('.count') : null;

                    if (countSpan && totalCount > 0) {
                        // Show "visible/total" format when filtering is active
                        const activeTypes = Array.from(filterToggles)
                            .filter(toggle => toggle.classList.contains('active'))
                            .map(toggle => toggle.dataset.type);

                        const isFiltering = activeTypes.length < filterToggles.length;

                        if (isFiltering && visibleCount !== totalCount) {
                            countSpan.textContent = `(${visibleCount}/${totalCount})`;
                        } else {
                            countSpan.textContent = `(${totalCount})`;
                        }
                    }
                });

                // Handle combined "user" filter separately (includes bash messages)
                const visibleUserMessages = document.querySelectorAll(`.message.user:not(.session-header):not(.filtered-hidden), .message.bash-input:not(.session-header):not(.filtered-hidden), .message.bash-output:not(.session-header):not(.filtered-hidden)`);
                const totalUserMessages = document.querySelectorAll(`.message.user:not(.session-header), .message.bash-input:not(.session-header), .message.bash-output:not(.session-header)`);
                const visibleUserCount = visibleUserMessages.length;
                const totalUserCount = totalUserMessages.length;

                const userToggle = document.querySelector(`[data-type="user"]`);
                const userCountSpan = userToggle ? userToggle.querySelector('.count') : null;

                if (userCountSpan && totalUserCount > 0) {
                    const activeTypes = Array.from(filterToggles)
                        .filter(toggle => toggle.classList.contains('active'))
                        .map(toggle => toggle.dataset.type);

                    const isFiltering = activeTypes.length < filterToggles.length;

                    if (isFiltering && visibleUserCount !== totalUserCount) {
                        userCountSpan.textContent = `(${visibleUserCount}/${totalUserCount})`;
                    } else {
                        userCountSpan.textContent = `(${totalUserCount})`;
                    }
                }

                // Handle combined "tool" filter separately
                const visibleToolMessages = document.querySelectorAll(`.message.tool_use:not(.session-header):not(.filtered-hidden), .message.tool_result:not(.session-header):not(.filtered-hidden)`);
                const totalToolMessages = document.querySelectorAll(`.message.tool_use:not(.session-header), .message.tool_result:not(.session-header)`);
                const visibleToolCount = visibleToolMessages.length;
                const totalToolCount = totalToolMessages.length;

                const toolToggle = document.querySelector(`[data-type="tool"]`);
                const toolCountSpan = toolToggle ? toolToggle.querySelector('.count') : null;

                if (toolCountSpan && totalToolCount > 0) {
                    const activeTypes = Array.from(filterToggles)
                        .filter(toggle => toggle.classList.contains('active'))
                        .map(toggle => toggle.dataset.type);

                    const isFiltering = activeTypes.length < filterToggles.length;

                    if (isFiltering && visibleToolCount !== totalToolCount) {
                        toolCountSpan.textContent = `(${visibleToolCount}/${totalToolCount})`;
                    } else {
                        toolCountSpan.textContent = `(${totalToolCount})`;
                    }
                }
            }

            function toggleFilter(button) {
                button.classList.toggle('active');
                applyFilter();
            }

            function selectAllTypes() {
                filterToggles.forEach(toggle => {
                    toggle.classList.add('active');
                });
                applyFilter();
            }

            function selectNoTypes() {
                filterToggles.forEach(toggle => {
                    toggle.classList.remove('active');
                });
                applyFilter();
            }

            // Event listeners for filter toggles
            filterToggles.forEach(toggle => {
                toggle.addEventListener('click', () => toggleFilter(toggle));
            });

            selectAllButton.addEventListener('click', selectAllTypes);
            selectNoneButton.addEventListener('click', selectNoTypes);

            // Initialize button state and message counts
            updateToggleButton();
            updateMessageCounts();

            // Apply URL filters first (if any)
            applyUrlFilters();

            // Apply all filters on page load
            applyFilter();

            // Fold/unfold functionality with horizontal fold bars
            const foldBarSections = document.querySelectorAll('.fold-bar-section');

            foldBarSections.forEach(section => {
                section.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const action = this.getAttribute('data-action');
                    const targetId = this.getAttribute('data-target');
                    const isFolded = this.classList.contains('folded');

                    handleFold(targetId, isFolded, this);
                });
            });

            // Update tooltip based on fold state
            function updateTooltip(section) {
                const isFolded = section.classList.contains('folded');
                const tooltip = isFolded
                    ? section.getAttribute('data-title-folded')
                    : section.getAttribute('data-title-unfolded');
                section.setAttribute('title', tooltip);
            }

            function handleFold(targetId, isFolded, sectionElement) {
                // Find all messages in the document
                const allMessages = document.querySelectorAll('.message');

                // Find immediate children: messages that have targetId as their LAST ancestor
                const immediateChildren = Array.from(allMessages).filter(msg => {
                    const classList = Array.from(msg.classList);
                    if (!classList.includes(targetId)) return false;
                    const ancestorIds = classList.filter(cls => cls.startsWith('d-'));
                    const lastAncestor = ancestorIds[ancestorIds.length - 1];
                    return lastAncestor === targetId;
                });

                if (isFolded) {
                    // Unfold: show immediate children
                    immediateChildren.forEach(msg => {
                        msg.style.display = '';

                        // Set newly revealed children to folded state
                        const foldBar = msg.querySelector('.fold-bar');
                        if (foldBar) {
                            const foldBtn = foldBar.querySelector('.fold-bar-section');
                            if (foldBtn) {
                                foldBtn.classList.add('folded');
                                foldBtn.querySelector('.fold-icon').textContent = 'â–¶';
                                updateTooltip(foldBtn);
                            }
                        }
                    });
                    sectionElement.classList.remove('folded');
                    sectionElement.querySelector('.fold-icon').textContent = 'â–¼';
                    updateTooltip(sectionElement);
                } else {
                    // Fold: hide ALL descendants
                    const allDescendants = document.querySelectorAll(`.message.${targetId}`);
                    allDescendants.forEach(msg => {
                        msg.style.display = 'none';
                    });
                    sectionElement.classList.add('folded');
                    sectionElement.querySelector('.fold-icon').textContent = 'â–¶';
                    updateTooltip(sectionElement);
                }
            }

            // Set initial fold state on page load
            function setInitialFoldState() {
                // Get all messages once
                const allMessages = document.querySelectorAll('.message');

                // Build hierarchy lookup structure in a single pass - O(n)
                const messagesByParentId = {};  // Maps parent ID -> immediate children elements
                const allDescendantsByParentId = {};  // Maps parent ID -> all descendant elements

                allMessages.forEach(msg => {
                    const classList = Array.from(msg.classList);
                    const ancestorIds = classList.filter(cls => cls.startsWith('d-'));

                    if (ancestorIds.length > 0) {
                        const lastAncestor = ancestorIds[ancestorIds.length - 1];

                        // Track immediate children
                        if (!messagesByParentId[lastAncestor]) {
                            messagesByParentId[lastAncestor] = [];
                        }
                        messagesByParentId[lastAncestor].push(msg);

                        // Track all descendants
                        ancestorIds.forEach(ancestorId => {
                            if (!allDescendantsByParentId[ancestorId]) {
                                allDescendantsByParentId[ancestorId] = [];
                            }
                            allDescendantsByParentId[ancestorId].push(msg);
                        });
                    }
                });

                // Now process each message using cached hierarchy - O(n)
                allMessages.forEach(msg => {
                    const messageId = msg.getAttribute('data-message-id');
                    if (!messageId) return;

                    const isSession = msg.classList.contains('session-header');
                    const isUser = msg.classList.contains('user');
                    const foldBar = msg.querySelector('.fold-bar');

                    if (!foldBar) return;

                    const foldBtn = foldBar.querySelector('.fold-bar-section');

                    // Check if user message has only tools (no assistant/system/thinking children)
                    let hasOnlyTools = false;
                    if (isUser) {
                        const immediateChildren = messagesByParentId[messageId] || [];

                        const hasNonToolChildren = immediateChildren.some(child =>
                            child.classList.contains('assistant') ||
                            child.classList.contains('system') ||
                            child.classList.contains('thinking')
                        );
                        hasOnlyTools = immediateChildren.length > 0 && !hasNonToolChildren;
                    }

                    // Sessions and user messages (unless they have only tools): unfolded at first level
                    if ((isSession || isUser) && !hasOnlyTools) {
                        if (foldBtn) {
                            foldBtn.classList.remove('folded');
                            foldBtn.querySelector('.fold-icon').textContent = 'â–¼';
                            updateTooltip(foldBtn);
                        }

                        // Show immediate children, hide deeper descendants
                        const allDescendants = allDescendantsByParentId[messageId] || [];
                        const immediateChildren = messagesByParentId[messageId] || [];

                        allDescendants.forEach(descendant => {
                            if (immediateChildren.includes(descendant)) {
                                descendant.style.display = '';

                                // Set immediate children to folded state
                                const childFoldBar = descendant.querySelector('.fold-bar');
                                if (childFoldBar) {
                                    const childFoldBtn = childFoldBar.querySelector('.fold-bar-section');
                                    if (childFoldBtn) {
                                        childFoldBtn.classList.add('folded');
                                        childFoldBtn.querySelector('.fold-icon').textContent = 'â–¶';
                                        updateTooltip(childFoldBtn);
                                    }
                                }
                            } else {
                                descendant.style.display = 'none';
                            }
                        });
                    } else {
                        // Assistant, system, thinking, tools, sidechains, OR user messages with only tools: fully folded
                        if (foldBtn) {
                            foldBtn.classList.add('folded');
                            foldBtn.querySelector('.fold-icon').textContent = 'â–¶';
                            updateTooltip(foldBtn);
                        }

                        // Hide all descendants
                        const allDescendants = allDescendantsByParentId[messageId] || [];
                        allDescendants.forEach(descendant => {
                            descendant.style.display = 'none';
                        });
                    }
                });
            }

            // Apply initial fold state
            setInitialFoldState();
        });
    </script>
    <!-- Search functionality script -->
    {% set is_transcript = True %}
    {% include 'components/search.html' %}
</body>

</html>