"""Custom syrupy serializers for HTML and Markdown snapshot testing."""

import re
from typing import Any

from syrupy.extensions.amber import AmberSnapshotExtension
from syrupy.types import SerializableData

# Shared normalisation patterns (used by both HTML and Markdown serializers)
# Library version comment - changes between releases
_VERSION_PATTERN = r"<!-- Generated by claude-code-log v[\d.]+(-\w+)? -->"
_VERSION_REPLACEMENT = "<!-- Generated by claude-code-log v[VERSION] -->"

# Pytest tmp paths - varies per test run
# Handles: /tmp/pytest-123/..., /private/var/folders/.../tmp/pytest-123/...
_TMP_PATH_PATTERN = (
    r"(/private)?(/var/folders/[^/]+/[^/]+/[^/]+/)?/tmp/pytest-[^\s\"'<>]+"
)
_TMP_PATH_REPLACEMENT = "/[TMP_PATH]"


class NormalisedHTMLSerializer(AmberSnapshotExtension):
    """
    Custom serializer that normalises dynamic content in HTML output.

    Normalises only truly dynamic content:
    - Library version comments (changes between releases)
    - Pytest tmp paths (varies per test run)

    Note: Timestamps, UUIDs, message IDs, token counts etc. come from the
    source JSONL test fixtures which are committed and static - no normalisation needed.
    """

    @classmethod
    def serialize(cls, data: SerializableData, **kwargs: Any) -> str:
        if isinstance(data, str):
            normalised = cls._normalise_html(data)
            return normalised
        return str(super().serialize(data, **kwargs))

    @classmethod
    def _normalise_html(cls, html: str) -> str:
        """Apply normalisation rules to HTML content."""
        html = re.sub(_VERSION_PATTERN, _VERSION_REPLACEMENT, html)
        html = re.sub(_TMP_PATH_PATTERN, _TMP_PATH_REPLACEMENT, html)

        # Last modified timestamps in project index (timezone-dependent)
        # ðŸ•’ 2023-11-14 23:15:00 -> ðŸ•’ [LAST_MODIFIED]
        # These come from datetime.fromtimestamp() which uses local timezone
        html = re.sub(
            r"ðŸ•’ \d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}</div>",
            "ðŸ•’ [LAST_MODIFIED]</div>",
            html,
        )

        return html
